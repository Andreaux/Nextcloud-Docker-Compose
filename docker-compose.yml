
name: nextcloud

# Nextcloud Stack
#
# Author: Andreaux
# URL: https://github.com/Andreaux/Nextcloud-Docker-Compose
#
# 1. Nextcloud
# 2. MariaDB
# 3. Redis
# 4. Nextcloud-cronjobs
# 5. Collabora
# 6. HaRP (Nextcloud AppAPI reverse proxy)
# 7. WebSocket Server for Real-time Collaboration

services:

# 1. Nextcloud (NOTE: update the docker image version number below if needed!)

  nextcloud:
    image: nextcloud:32.0.5
    container_name: nextcloud
    restart: unless-stopped
    depends_on:
      db:
        condition: service_started
      collabora:
        condition: service_started
      redis:
        condition: service_started
    hostname: nc
    environment:
      # PHP tuning
      - PHP_MEMORY_LIMIT=1G
      # Redis cache
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - 'REDIS_HOST_PASSWORD=${REDIS_PASSWORD}'
      # Optional: if you want to control trusted domains via env (or do it in config.php)
      # - NEXTCLOUD_TRUSTED_DOMAINS=nc.${DOMAINNAME}
    volumes:
      - ./nextclouddata:/var/www/html
    networks:
      - proxy
    ports:
      # These ports are in format <host-port>:<container-port>
      # Only needed if you want to reach NC directly from the host.
      # If your reverse proxy (NPM) is also in Docker and on the "proxy" network,
      # you can remove these and point NPM directly to http://nextcloud:80.
      - '9000:80'
      - '9443:443'

# 2. MariaDB

  db:
    image: mariadb:11.5.2
    container_name: ncdb
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: '${MYSQL_ROOT_PASSWORD}'
      MYSQL_DATABASE: 'nextcloud'
      MYSQL_USER: 'nextcloud'
      MYSQL_PASSWORD: '${MYSQL_PASSWORD}'
      MARIADB_AUTO_UPGRADE: '1'
    volumes:
      - ./mysql:/var/lib/mysql
    networks:
      - proxy
    ports:
      # These ports are in format <host-port>:<container-port>
      - '3306:3306' # MySQL Port

# 3. Redis

  redis:
    image: redis:alpine
    container_name: redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD}
    networks:
      - proxy
    ports:
      - '6379:6379'

# 4. Nextcloud-cronjob

  nextcloud-cronjob:
    image: rcdailey/nextcloud-cronjob
    container_name: nextcloud-cronjob
    depends_on:
      nextcloud:
        condition: service_started
    restart: unless-stopped
    environment:
      - NEXTCLOUD_CONTAINER_NAME=nextcloud
#      - NEXTCLOUD_PROJECT_NAME=nextcloud
      - NEXTCLOUD_CRON_MINUTE_INTERVAL=5
      - NEXTCLOUD_EXEC_SHELL=bash
      - NEXTCLOUD_EXEC_SHELL_ARGS=-c
      - NEXTCLOUD_EXEC_USER=www-data
      - PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
    volumes:
      - ./nextclouddata:/var/www/html
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - proxy

# 5. Collabora

  collabora:
    image: collabora/code:latest
    container_name: collabora
    hostname: collabora
    domainname: ${DOMAINNAME}
    volumes:
      - /etc/localtime:/etc/localtime
      - /etc/timezone:/etc/timezone
    restart: unless-stopped
    environment:
      # Set your dictionary languages below. Remove any unnecessary, add missing ones.
      - dictionaries=en_US,hu_HU,fr_FR,de_DE
      # Escaped domain for Collabora (e.g. "nextcloud\.example\.com|example\.com" in .env)
      - domain=${ESCAPED_COLLABORA_DOMAINNAME}
      # SSL is terminated at reverse proxy (NPM), so we disable it inside Collabora
      - extra_params=--o:ssl.enable=false --o:ssl.termination=true

      - LC_CTYPE=C.UTF-8
      - PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
      # Collabora admin UI
      - username=admin
      - password=${COLLABORA_PASSWORD}
      # These are used by common nginx-proxy / NPM-style setups
      - VIRTUAL_HOST=ca.${DOMAINNAME}
      - VIRTUAL_PORT=9980
      - VIRTUAL_PROTO=https
    networks:
      - proxy

# 6. HaRP (Nextcloud AppAPI reverse proxy)

  appapi-harp:
    image: ghcr.io/nextcloud/nextcloud-appapi-harp:release
    container_name: appapi-harp
    depends_on:
      nextcloud:
        condition: service_started
    restart: unless-stopped
    hostname: appapi-harp
    environment:
      # MUST match the shared key configured in the Nextcloud daemon
      HP_SHARED_KEY: ${HP_SHARED_KEY}
      # Public Nextcloud URL (same as what users see in browser and NPM)
      NC_INSTANCE_URL: https://nc.${DOMAINNAME}

      # HP_EXAPPS_ADDRESS / HP_FRP_ADDRESS use sane defaults:
      # 0.0.0.0:8780 and 0.0.0.0:8782 inside the container.
      # We don't set them here unless we have a special reason.

      # If you want stricter IP handling and your reverse proxy is on the same
      # network, you can optionally add something like:
      # HP_TRUSTED_PROXY_IPS=192.168.0.0/16
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./certs:/certs
    ports:
      # Only needed if NPM reaches HaRP via host IP/ports.
      # If NPM is on the same Docker network, you can skip ports
      # and just point NPM to http://appapi-harp:8780.
      - "8780:8780"   # HTTP API for ExApps (/exapps/)
      - "8782:8782"   # FRP (reverse proxy tunnel)
    networks:
      - proxy

# 7. WebSocket Server for Real-time Collaboration
#
# Don't forget to add the custom location for the Whiteboard to Nginx.
# See README.md for what to set.
#
  nextcloud-whiteboard-server:
    image: ghcr.io/nextcloud/whiteboard:stable
    container_name: whiteboard
    depends_on:
      nextcloud:
        condition: service_started
    restart: unless-stopped
    ports:
      - "3002:3002"
    environment:
      NEXTCLOUD_URL: https://nc.${DOMAINNAME}
      JWT_SECRET_KEY: ${WHITEBOARD_JWT_SECRET}
      MAX_UPLOAD_FILE_SIZE: 20971520
    networks:
      - proxy

networks:
  proxy:
    name: proxy
    external: true
